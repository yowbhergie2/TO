<script>
let LATEST_DATE_PREPARED = null;
let ALL_TRAVEL_ORDERS = [];
let PROJECT_ENGINEERS = [];
let EMPLOYEES_LIST = [];
let APPROVERS_LIST = [];
let RECENT_PURPOSES = [];
let RECENT_STATIONS = [];
let EMPLOYEE_POSITIONS = []; 
let ENGINEER_POSITIONS = [];
let CURRENT_VIEW = 'dashboard';
let _successModalRedirect = 'dashboard'; 
let _toIdToEdit = null;

// --- MODIFICATION FOR LOCKING ---
// Array para sa mga TO_IDs na na-unlock sa session na ito
let UNLOCKED_TO_IDS = []; 
// Sinusubaybayan kung lagpas 5 PM na
let isAfter5PM = (new Date().getHours() >= 17); 
let relockTimer = null; // Timer para sa auto-lock
// --- END MODIFICATION ---

const getTodayDate = () => {
    const today = new Date();
    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
    return today.toISOString().split('T')[0];
};

const addDays = (date, days) => {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
};

const formatToYyyyMmDd = (isoDate) => {
    if (!isoDate) return '';
    const date = new Date(isoDate);
    date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
    return date.toISOString().split('T')[0];
};

const formatInclusiveDates = (startStr, endStr) => {
    if (!startStr || !endStr) return 'N/A';
    try {
        const startDate = new Date(startStr);
        const endDate = new Date(endStr);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        
        const startLocale = startDate.toLocaleDateString('en-US', options);
        const endLocale = endDate.toLocaleDateString('en-US', options);

        if (startLocale === endLocale) return startLocale;

        const startMonth = startDate.getMonth();
        const startYear = startDate.getFullYear();
        const endMonth = endDate.getMonth();
        const endYear = endDate.getFullYear();

        if (startYear !== endYear) {
            return `${startLocale} — ${endLocale}`;
        }
        if (startMonth !== endMonth) {
            return `${startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })} — ${endLocale}`;
        }
        
        const startDay = startDate.getDate();
        const endDay = endDate.getDate();
        return `${startDate.toLocaleDateString('en-US', { month: 'long' })} ${startDay}–${endDay}, ${startYear}`;
    } catch (e) {
        console.error("Error formatting dates:", startStr, endStr, e);
        return "Invalid Date";
    }
};

const formatDateForDisplay = (dateStr) => {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
};

const showLoader = (message = "Loading...") => {
    const loader = document.getElementById('loader');
    const loaderMessage = document.getElementById('loader-message');
    if (loader && loaderMessage) {
        loaderMessage.textContent = message;
        loader.style.display = 'flex';
    }
};

const hideLoader = () => {
    const loader = document.getElementById('loader');
    if (loader) {
        loader.style.display = 'none';
    }
};

const showToast = (message, isError = false) => {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    
    if (toast && toastMessage) {
        toastMessage.textContent = message;
        toast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transition-transform duration-300 ease-out z-40';
        toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500', 'show');
        
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
};

const showFormError = (inputId, message) => {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    // Find the next sibling that is a 'form-error-msg'
    let errorMsg = input.nextElementSibling;
    while(errorMsg && !errorMsg.classList.contains('form-error-msg')) {
        errorMsg = errorMsg.nextElementSibling;
    }

    if (errorMsg?.classList.contains('form-error-msg')) {
        input.classList.add('invalid');
        errorMsg.textContent = message;
        errorMsg.classList.remove('hidden');
    }
};

const clearFormErrors = (formId) => {
    const form = document.getElementById(formId);
    if (!form) return;
    form.querySelectorAll('.form-error-msg').forEach(el => el.classList.add('hidden'));
    form.querySelectorAll('.invalid').forEach(el => el.classList.remove('invalid'));
};

const updateNavActiveState = (viewName) => {
    CURRENT_VIEW = viewName;
    
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.toggle('active', link.id === `nav-${viewName}`);
    });
    
    document.querySelectorAll('.nav-link-mobile').forEach(link => {
        link.classList.toggle('active', link.id === `nav-${viewName}-mobile`);
    });

    const mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenu) {
        mobileMenu.classList.add('hidden');
    }
};

function setupNavListeners() {
    const navItems = [
        { id: 'nav-dashboard', view: 'dashboard' },
        { id: 'nav-travel-orders', view: 'travel-orders' },
        { id: 'nav-new-to', view: 'new' },
        { id: 'nav-master-data', view: 'master-data' },
        { id: 'nav-dashboard-mobile', view: 'dashboard' },
        { id: 'nav-travel-orders-mobile', view: 'travel-orders' },
        { id: 'nav-new-to-mobile', view: 'new' },
        { id: 'nav-master-data-mobile', view: 'master-data' }
    ];

    navItems.forEach(({ id, view }) => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('click', (e) => {
                e.preventDefault();
                if (CURRENT_VIEW !== view) {
                    if (view === 'dashboard') loadDashboardView();
                    else if (view === 'travel-orders') loadTravelOrdersView();
                    else if (view === 'new') loadNewToView();
                    else if (view === 'master-data') loadMasterDataView();
                }
            });
        }
    });

    const mobileMenuBtn = document.getElementById('mobile-menu-button');
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', () => {
            const menu = document.getElementById('mobile-menu');
            if (menu) {
                menu.classList.toggle('hidden');
                document.querySelectorAll('#mobile-menu-button svg').forEach(svg => svg.classList.toggle('hidden'));
            }
        });
    }
}

window.addEventListener('load', () => {
    console.log("=== SYSTEM INITIALIZING ===");
    showLoader("Initializing System...");
    
    setupNavListeners();

    const closeBtn = document.getElementById('success-modal-close-btn');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            closeSuccessModal();
            
            if (_successModalRedirect === 'clear_new_form') {
                if (typeof resetNewToForm === 'function') {
                    resetNewToForm();
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (_successModalRedirect === 'travel_orders') {
                loadTravelOrdersView();
            } else {
                loadDashboardView(); // Default fallback
            }
        });
    }

    // MODIFICATION: Add password modal listeners
    const passModalCloseBtn = document.getElementById('password-modal-close-btn');
    if (passModalCloseBtn) {
        passModalCloseBtn.addEventListener('click', closePasswordModal);
    }
    const passModalSubmitBtn = document.getElementById('password-modal-submit-btn');
    if (passModalSubmitBtn) {
        passModalSubmitBtn.addEventListener('click', handleSubmitPassword);
    }
    const passForm = document.getElementById('password-form');
    if (passForm) {
        // The form tag already has onsubmit, but this is a good fallback.
        passForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleSubmitPassword();
        });
    }
    
    // --- MODIFICATION FOR LOCKING ---
    // Simulan ang timer na nagche-check kada minuto para sa 5 PM auto-lock
    if (!relockTimer) {
        relockTimer = setInterval(checkAutoRelock, 60000); // Check every minute
    }
    // --- END MODIFICATION ---
    
    google.script.run
        .withSuccessHandler(onInitialLoadSuccess)
        .withFailureHandler(onInitialLoadFailure)
        .getInitialData();
});

function onInitialLoadSuccess(data) {
    console.log("=== INITIAL DATA RECEIVED ===");
    console.log("Data:", data);
    
    if (data.error) {
        console.error("Data contains error:", data.error);
        onInitialLoadFailure({ message: data.error });
        return;
    }
    
    LATEST_DATE_PREPARED = data.latestDate ? new Date(data.latestDate) : null;
    ALL_TRAVEL_ORDERS = data.travelOrders || [];
    PROJECT_ENGINEERS = data.projectEngineers || [];
    EMPLOYEES_LIST = data.employees || [];
    APPROVERS_LIST = data.approvers || [];
    RECENT_PURPOSES = data.recentPurposes || [];
    RECENT_STATIONS = data.recentStations || [];
    EMPLOYEE_POSITIONS = data.employeePositions || [];
    ENGINEER_POSITIONS = data.engineerPositions || []; // MODIFICATION: Store engineer positions
    
    console.log("Travel Orders:", ALL_TRAVEL_ORDERS.length);
    console.log("Employees:", EMPLOYEES_LIST.length);
    console.log("Project Engineers:", PROJECT_ENGINEERS.length);
    console.log("Approvers:", APPROVERS_LIST.length);
    console.log("Employee Positions:", EMPLOYEE_POSITIONS.length);
    console.log("Engineer Positions:", ENGINEER_POSITIONS.length); // MODIFICATION
    
    loadDashboardView();
}

function onInitialLoadFailure(error) {
    console.error("=== INITIAL LOAD FAILED ===");
    console.error("Error:", error);
    hideLoader();
    showToast("Failed to load data: " + error.message, true);
}

/**
 * @description Populates an employee dropdown.
 * @param {HTMLSelectElement} selectElement The <select> element to populate.
 * @param {string[]} [excludeValues=[]] An array of names to exclude.
 * @param {string | null} [valueToInclude=null] A specific name to include, even if inactive.
 */
function populateEmployeeDropdown(selectElement, excludeValues = [], valueToInclude = null) {
    selectElement.innerHTML = '<option value="">Select Employee</option>';
    let includedValue = false;
    
    const activeEmployees = EMPLOYEES_LIST
        .filter(emp => emp.status.trim() === 'ACTIVE' && !excludeValues.includes(emp.name));
        
    activeEmployees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.name;
        option.textContent = emp.name;
        selectElement.appendChild(option);
        if (emp.name === valueToInclude) {
            includedValue = true;
        }
    });

    // If the saved value is not in the active list (e.g., they are inactive OR excluded)
    // we must add them to the list anyway so the dropdown can display them.
    if (valueToInclude && !includedValue) {
        // Check the *master* list for the status, not the filtered list.
        const employee = EMPLOYEES_LIST.find(emp => emp.name === valueToInclude);
        const isInactive = employee && employee.status.trim() === 'INACTIVE';
        
        const option = document.createElement('option');
        option.value = valueToInclude;
        option.textContent = isInactive ? `${valueToInclude} (Inactive)` : valueToInclude; // Only add (Inactive) if truly inactive
        if (isInactive) {
            option.style.color = "#6b7280"; // Gray text
        }
        selectElement.appendChild(option);
    }
}

/**
 * @description Populates the project engineer dropdown.
 * @param {HTMLSelectElement} selectElement The <select> element to populate.
 * @param {string | null} [valueToInclude=null] A specific name to include, even if inactive.
 */
function populateProjectEngineerDropdown(selectElement, valueToInclude = null) {
    selectElement.innerHTML = '<option value="">Select Project Engineer</option>';
    let includedValue = false;

    const activeEngineers = PROJECT_ENGINEERS
        .filter(pe => pe.status.trim() === 'ACTIVE');

    activeEngineers.forEach(pe => {
        const option = document.createElement('option');
        option.value = pe.name;
        option.textContent = pe.name;
        selectElement.appendChild(option);
        if (pe.name === valueToInclude) {
            includedValue = true;
        }
    });

    // If the saved value is not in the active list
    if (valueToInclude && !includedValue) {
        // Check the *master* list for the status
        const engineer = PROJECT_ENGINEERS.find(pe => pe.name === valueToInclude);
        const isInactive = engineer && engineer.status.trim() === 'INACTIVE';

        const option = document.createElement('option');
        option.value = valueToInclude;
        option.textContent = isInactive ? `${valueToInclude} (Inactive)` : valueToInclude;
        if (isInactive) {
            option.style.color = "#6b7280";
        }
        selectElement.appendChild(option);
    }
}

function getSelectedEmployees(containerId) {
    const selects = document.querySelectorAll(`#${containerId} .employee-select`);
    return Array.from(selects).map(sel => sel.value).filter(val => val);
}

/**
 * @description Re-populates all employee dropdowns, respecting existing selections
 * and ensuring inactive selected employees remain in their lists.
 */
function updateAllEmployeeDropdowns(containerId) {
    const selectedEmployees = getSelectedEmployees(containerId);
    const selects = document.querySelectorAll(`#${containerId} .employee-select`);
    
    selects.forEach(select => {
        const currentValue = select.value;
        // We must pass `currentValue` as the `valueToInclude` to ensure it
        // doesn't get removed from its *own* list if it's inactive.
        const excludeValues = selectedEmployees.filter(emp => emp !== currentValue);
        populateEmployeeDropdown(select, excludeValues, currentValue); 
        select.value = currentValue;
    });
}

/**
 * @description Creates a new employee row with a dropdown.
 * @param {HTMLElement} container The container element to append the row to.
 * @param {string | null} [valueToInclude=null] The name of the employee to pre-select.
 * @returns {HTMLElement} The newly created row element.
 */
function createEmployeeRow(container, valueToInclude = null) {
    const row = document.createElement('div');
    row.className = 'employee-row flex gap-2';
    
    const select = document.createElement('select');
    select.className = 'employee-select flex-1 input-field';
    select.required = true;
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-employee-btn bg-red-50 text-red-600 px-4 rounded-lg hover:bg-red-100 transition-all';
    removeBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
    </svg>`;
    
    select.addEventListener('change', () => {
        updateAllEmployeeDropdowns(container.id);
    });
    
    removeBtn.addEventListener('click', () => {
        row.remove();
        updateEmployeeRemoveButtons(container);
        updateAllEmployeeDropdowns(container.id);
    });
    
    row.appendChild(select);
    row.appendChild(removeBtn);
    container.appendChild(row);
    
    // Get all *other* selected values
    const selectedEmployees = getSelectedEmployees(container.id);
    const excludeValues = selectedEmployees.filter(emp => emp !== valueToInclude);
    
    // Populate this new dropdown
    populateEmployeeDropdown(select, excludeValues, valueToInclude);
    
    // Set the value *after* populating
    if (valueToInclude) {
        select.value = valueToInclude;
    }
    
    updateEmployeeRemoveButtons(container);
    
    return row;
}

function updateEmployeeRemoveButtons(container) {
    const rows = container.querySelectorAll('.employee-row');
    rows.forEach(row => {
        const removeBtn = row.querySelector('.remove-employee-btn');
        removeBtn.classList.toggle('hidden', rows.length === 1);
    });
}

function setupSuggestions(inputId, suggestionsId, dataArray) {
    const input = document.getElementById(inputId);
    const suggestionsDiv = document.getElementById(suggestionsId);
    
    if (!input || !suggestionsDiv) return;

    input.addEventListener('focus', () => {
        if (dataArray.length > 0) {
            suggestionsDiv.innerHTML = '';
            dataArray.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = item;
                div.addEventListener('click', () => {
                    input.value = item;
                    suggestionsDiv.classList.add('hidden');
                });
                suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.classList.remove('hidden');
        }
    });

    input.addEventListener('blur', () => {
        setTimeout(() => suggestionsDiv.classList.add('hidden'), 200);
    });

    input.addEventListener('input', () => {
        const searchTerm = input.value.toLowerCase();
        const filtered = dataArray.filter(item => item.toLowerCase().includes(searchTerm));
        
        if (filtered.length > 0 && input.value) {
            suggestionsDiv.innerHTML = '';
            filtered.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = item;
                div.addEventListener('click', () => {
                    input.value = item;
                    suggestionsDiv.classList.add('hidden');
                });
                suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.classList.remove('hidden');
        } else {
            suggestionsDiv.classList.add('hidden');
        }
    });
}

function setupModeOfTravelListener(selectId, containerId, inputId) {
    const select = document.getElementById(selectId);
    const container = document.getElementById(containerId);
    const input = document.getElementById(inputId);
    
    select.addEventListener('change', () => {
        if (select.value === 'OTHER') {
            container.classList.remove('hidden');
            input.required = true;
        } else {
            container.classList.add('hidden');
            input.required = false;
            input.value = '';
        }
    });
}

function handleGeneratePdf(toId) {
    showLoader("Generating PDF...");
    
    google.script.run
        .withSuccessHandler(onPdfSuccess)
        .withFailureHandler(onPdfFailure)
        .generateAndLinkPdf(toId, null);
}

function onPdfSuccess(result) {
    if (result.success) {
        showToast("PDF Generated Successfully!");
        window.open(result.pdfUrl, '_blank');
        
        showLoader("Refreshing data...");
        google.script.run
            .withSuccessHandler(data => {
                if (data.error) {
                    onInitialLoadFailure({ message: data.error });
                    return;
                }
                LATEST_DATE_PREPARED = data.latestDate ? new Date(data.latestDate) : null;
                ALL_TRAVEL_ORDERS = data.travelOrders;
                PROJECT_ENGINEERS = data.projectEngineers || [];
                EMPLOYEES_LIST = data.employees || [];
                APPROVERS_LIST = data.approvers || [];
                RECENT_PURPOSES = data.recentPurposes || [];
                RECENT_STATIONS = data.recentStations || [];
                EMPLOYEE_POSITIONS = data.employeePositions || []; 
                ENGINEER_POSITIONS = data.engineerPositions || []; // MODIFICATION: Refresh positions
                
                if (CURRENT_VIEW === 'travel-orders') {
                    populateDashboardTable(ALL_TRAVEL_ORDERS);
                }
                hideLoader();
            })
            .withFailureHandler(onInitialLoadFailure)
            .getInitialData();
    } else {
        onPdfFailure({ message: result.error });
    }
}

function onPdfFailure(error) {
    console.error("PDF Generation Error:", error);
    showToast("PDF Generation Failed: " + error.message, true);
    hideLoader();
}

// --- MODIFICATION FOR LOCKING ---
/**
 * @description Tine-check bawat minuto kung lumagpas na ng 5 PM.
 * Kung oo, ila-lock ulit nito ang lahat ng entries.
 */
function checkAutoRelock() {
    const now = new Date();
    const currentIsAfter5PM = (now.getHours() >= 17); // 5 PM or later (17:00)

    if (currentIsAfter5PM && !isAfter5PM) {
        // Kakalagpas lang ng 5 PM
        console.log("Auto-locking entries after 5 PM.");
        isAfter5PM = true; // Itakda ang flag
        
        if (UNLOCKED_TO_IDS.length > 0) {
            UNLOCKED_TO_IDS = []; // I-clear ang listahan ng mga na-unlock
            
            // Kung nasa 'travel-orders' view, i-refresh ang table para ipakita ang locked buttons
            if (CURRENT_VIEW === 'travel-orders') {
                populateDashboardTable(ALL_TRAVEL_ORDERS);
            }
            showToast("It's after 5 PM. All unlocked entries have been re-locked.");
        }
    } else if (!currentIsAfter5PM && isAfter5PM) {
        // Kakalagpas lang ng hatinggabi (12 AM), i-reset ang flag para bukas
        console.log("Resetting 5 PM lock state for new day.");
        isAfter5PM = false;
    }
}
// --- END MODIFICATION ---


/**
 * @description Hides the global success modal.
 */
function closeSuccessModal() {
    const modal = document.getElementById('success-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// MODIFICATION: Add password modal functions
function showPasswordModal() {
    const modal = document.getElementById('password-modal');
    if (modal) {
        document.getElementById('admin-password').value = '';
        document.getElementById('password-error-msg').classList.add('hidden');
        modal.classList.remove('hidden');
        document.getElementById('admin-password').focus();
    }
}

function closePasswordModal() {
    const modal = document.getElementById('password-modal');
    if (modal) {
        modal.classList.add('hidden');
        _toIdToEdit = null; // Clear the stored ID
    }
}

function handleSubmitPassword() {
    const passwordInput = document.getElementById('admin-password');
    const errorMsg = document.getElementById('password-error-msg');
    const password = passwordInput.value;
    
    if (!password) {
        errorMsg.textContent = "Password cannot be empty.";
        errorMsg.classList.remove('hidden');
        return;
    }
    
    // --- MODIFICATION FOR LOCKING ---
    // Suriin kung lagpas 5 PM na bago pa man mag-check ng password
    if (isAfter5PM) {
        errorMsg.textContent = "Unlocking is disabled after 5:00 PM.";
        errorMsg.classList.remove('hidden');
        hideLoader();
        return; // Hihinto dito
    }
    // --- END MODIFICATION ---
    
    showLoader("Verifying...");
    
    google.script.run
        .withSuccessHandler(isAdmin => {
            hideLoader();
            if (isAdmin) {
                // --- MODIFICATION: Success Logic Updated ---
                errorMsg.classList.add('hidden');
                
                // 1. Idagdag sa listahan ng mga na-unlock
                if (!UNLOCKED_TO_IDS.includes(_toIdToEdit)) {
                    UNLOCKED_TO_IDS.push(_toIdToEdit);
                }
                
                closePasswordModal(); // 2. Isara ang modal
                
                // 3. I-refresh ang table para ipakita ang na-unlock na button
                //    (HINDI ididiretso sa edit page)
                if (CURRENT_VIEW === 'travel-orders') {
                    populateDashboardTable(ALL_TRAVEL_ORDERS);
                }
                // --- END MODIFICATION ---
            } else {
                errorMsg.textContent = "Incorrect password.";
                errorMsg.classList.remove('hidden');
                passwordInput.select();
            }
        })
        .withFailureHandler(err => {
            hideLoader();
            errorMsg.textContent = "Error: " + err.message;
            errorMsg.classList.remove('hidden');
        })
        .checkAdminPassword(password);
}
// END MODIFICATION
</script>

