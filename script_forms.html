<script>
let fpDatePrepared, fpInclusive, fpSubmission;
let fpUpdateDatePrepared, fpUpdateInclusive, fpUpdateSubmission;

function loadNewToView() {
    console.log("=== LOADING NEW TO VIEW ===");
    showLoader("Loading New Travel Order Form...");
    updateNavActiveState('new');

    google.script.run
        .withSuccessHandler(html => {
            console.log("New TO HTML received");
            document.getElementById('content-area').innerHTML = html;
            setTimeout(() => {
                setupNewToFormListeners();
                hideLoader();
            }, 200);
        })
        .withFailureHandler(err => {
            console.error("Failed to load new TO view:", err);
            showToast("Failed to load form: " + err.message, true);
            hideLoader();
        })
        .getNewToView();
}

function setupNewToFormListeners() {
    const form = document.getElementById('new-to-form');
    form.addEventListener('submit', handleNewToSubmit);
    
    document.getElementById('cancel-new-to-btn').addEventListener('click', (e) => {
        e.preventDefault();
        loadDashboardView(); // On New form, cancel goes to dashboard
    });

    const employeesContainer = document.getElementById('employees-container');
    const firstSelect = employeesContainer.querySelector('.employee-select');
    populateEmployeeDropdown(firstSelect);
    
    firstSelect.addEventListener('change', () => {
        updateAllEmployeeDropdowns('employees-container');
    });
    
    populateProjectEngineerDropdown(document.getElementById('requestingOfficer'));
    
    document.getElementById('add-employee-btn').addEventListener('click', () => {
        createEmployeeRow(employeesContainer, null); // Pass null for new rows
    });
    
    setupModeOfTravelListener('modeOfTravel', 'otherModeContainer', 'otherMode');
    setupDatePickers();
    updateEmployeeRemoveButtons(employeesContainer);
    
    setupSuggestions('purpose', 'purpose-suggestions', RECENT_PURPOSES);
    setupSuggestions('station', 'station-suggestions', RECENT_STATIONS);
}

function setupDatePickers() {
    const inclusiveDatesInput = document.getElementById('inclusiveDates');
    const inclusiveDatesDisplay = document.getElementById('inclusive-dates-display');
    const dateSubmissionInput = document.getElementById('dateSubmission');
    const submissionDateDisplay = document.getElementById('submission-date-display');
    
    fpDatePrepared = flatpickr("#datePrepared", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        // FIX: Allow selection of the latest date
        minDate: LATEST_DATE_PREPARED ? formatToYyyyMmDd(LATEST_DATE_PREPARED) : null,
        onChange: (selectedDates) => {
            if (selectedDates.length > 0) {
                const displayElem = document.getElementById('date-prepared-display');
                if (displayElem) {
                    displayElem.textContent = formatDateForDisplay(selectedDates[0].toISOString());
                }
                inclusiveDatesInput.disabled = false;
                if (fpInclusive) {
                    fpInclusive.set('minDate', selectedDates[0]);
                    fpInclusive.clear(); // Clear range if date prepared changes
                }
                // Also disable/clear submission
                dateSubmissionInput.disabled = true;
                if (fpSubmission) fpSubmission.clear();
            }
        }
    });
    
    fpInclusive = flatpickr("#inclusiveDates", {
        mode: "range",
        dateFormat: "Y-m-d",
        minDate: "today", // This will be updated by fpDatePrepared onChange
        onChange: (selectedDates) => {
            if (selectedDates.length === 2) {
                const startDate = selectedDates[0];
                const endDate = selectedDates[1];
                const formattedDisplay = formatInclusiveDates(startDate.toISOString(), endDate.toISOString());
                inclusiveDatesDisplay.textContent = formattedDisplay;
                
                const submissionDefaultDate = addDays(endDate, 3);
                
                dateSubmissionInput.disabled = false;
                if (fpSubmission) {
                    fpSubmission.set('minDate', endDate);
                    fpSubmission.setDate(submissionDefaultDate, true);
                }
            }
        }
    });

    fpSubmission = flatpickr("#dateSubmission", {
        dateFormat: "Y-m-d",
        minDate: "today", // This will be updated by fpInclusive onChange
        onChange: (selectedDates) => {
            if (selectedDates.length > 0) {
                submissionDateDisplay.textContent = formatDateForDisplay(selectedDates[0].toISOString());
            }
        }
    });
}

function validateNewToForm() {
    clearFormErrors('new-to-form');
    let isValid = true;
    
    const formData = {
        datePrepared: document.getElementById('datePrepared').value,
        inclusiveDates: document.getElementById('inclusiveDates').value,
        destination: document.getElementById('destination').value,
        station: document.getElementById('station').value,
        purpose: document.getElementById('purpose').value,
        modeOfTravel: document.getElementById('modeOfTravel').value,
        requestingOfficer: document.getElementById('requestingOfficer').value,
        dateSubmission: document.getElementById('dateSubmission').value,
    };
    
    if (formData.modeOfTravel === 'OTHER') {
        formData.modeOfTravel = document.getElementById('otherMode').value;
        if (!formData.modeOfTravel) {
            showFormError('otherMode', 'Please specify the mode of travel.'); 
            isValid = false;
        }
    }
    
    const employees = getSelectedEmployees('employees-container');
    
    if (employees.length === 0) {
        showToast("Please add at least one employee", true);
        isValid = false;
    }

    const requiredFields = [
        { id: 'datePrepared', name: 'Date Prepared' },
        { id: 'inclusiveDates', name: 'Inclusive Dates' },
        { id: 'destination', name: 'Destination' },
        { id: 'station', name: 'Station' },
        { id: 'purpose', name: 'Purpose' },
        { id: 'modeOfTravel', name: 'Mode of Travel' },
        { id: 'requestingOfficer', name: 'Requesting Officer' },
        { id: 'dateSubmission', name: 'Submission Date' }
    ];
    
    requiredFields.forEach(field => {
        if (!formData[field.id.replace(/-([a-z])/g, (g) => g[1].toUpperCase())]) {
            showFormError(field.id, `${field.name} is required.`);
            isValid = false;
        }
    });
    
    if (!isValid) return null;

    const dp = new Date(formData.datePrepared + 'T00:00:00');
    const today = new Date(getTodayDate() + 'T00:00:00');
    
    if (dp > today) {
        showFormError('datePrepared', 'Date Prepared cannot be in the future.');
        isValid = false;
    }
    // FIX: Allow date >= latest date (changed from < to <=)
    if (LATEST_DATE_PREPARED && dp < LATEST_DATE_PREPARED) {
        showFormError('datePrepared', `Date must be on or after the latest prepared date (${formatToYyyyMmDd(LATEST_DATE_PREPARED)}).`);
        isValid = false;
    }
    
    const [startStr, endStr] = formData.inclusiveDates.split(' to ');
    if (!startStr || !endStr) {
        showFormError('inclusiveDates', 'Please select a valid date range.');
        return null;
    }
    
    const start = new Date(startStr + 'T00:00:00');
    const end = new Date(endStr + 'T00:00:00');
    
    if (start < dp) {
        showFormError('inclusiveDates', 'Start Date cannot be before Date Prepared.');
        isValid = false;
    }
    if (end < start) {
        showFormError('inclusiveDates', 'End Date cannot be before Start Date.');
        isValid = false;
    }
    
    const submission = new Date(formData.dateSubmission + 'T00:00:00');
    if (submission < end) {
        showFormError('dateSubmission', 'Submission Date cannot be before Inclusive End Date.');
        isValid = false;
    }

    if (!isValid) return null;

    return {
        datePrepared: dp.toISOString(),
        inclusiveStart: start.toISOString(),
        inclusiveEnd: end.toISOString(),
        dateSubmission: submission.toISOString(),
        employees: employees,
        destination: formData.destination,
        station: formData.station,
        purpose: formData.purpose,
        modeOfTravel: formData.modeOfTravel,
        requestingOfficer: formData.requestingOfficer,
    };
}

function handleNewToSubmit(e) {
    e.preventDefault();
    const formData = validateNewToForm();
    
    if (formData) {
        showLoader("Saving Travel Order...");
        document.getElementById('save-to-btn').disabled = true;
        
        google.script.run
            .withSuccessHandler(onSaveSuccess) // This already handles PDF generation
            .withFailureHandler(onSaveFailure)
            .saveTravelOrder(formData);
    }
}

function onSaveSuccess(result) {
    if (result.success) {
        // Update global data
        ALL_TRAVEL_ORDERS.push(result.newRecord);
        const newDatePrepared = new Date(result.newRecord.Date_Prepared);
        if (!LATEST_DATE_PREPARED || newDatePrepared > LATEST_DATE_PREPARED) {
            LATEST_DATE_PREPARED = newDatePrepared;
        }
        
        _successModalRedirect = 'clear_new_form'; // Set redirect logic for modal close

        // Show success modal instead of toast/redirect
        showSuccessModal(
            "Save Successful!",
            "New Travel Order has been created and PDF generated.",
            result.newRecord.TO_ID,
            result.pdfUrl
        );
        
        // Re-enable button, hide loader
        document.getElementById('save-to-btn').disabled = false;
        hideLoader();

    } else {
        onSaveFailure({ message: result.error });
    }
}

function onSaveFailure(error) {
    console.error("Save Error:", error);
    showToast("Save Failed: " + error.message, true);
    document.getElementById('save-to-btn').disabled = false;
    hideLoader();
}

function loadUpdateView(toId) {
    console.log("=== LOADING UPDATE VIEW ===");
    showLoader("Loading Update Form...");
    updateNavActiveState('new'); // Keep 'new' active as it's a form

    google.script.run
        .withSuccessHandler(html => {
            console.log("Update HTML received");
            document.getElementById('content-area').innerHTML = html;
            
            setTimeout(() => {
                const data = ALL_TRAVEL_ORDERS.find(to => to.TO_ID === toId);
                if (data) {
                    populateUpdateForm(data);
                    setupUpdateFormListeners();
                }
                hideLoader();
            }, 200);
        })
        .withFailureHandler(err => {
            console.error("Failed to load update view:", err);
            showToast("Failed to load update form: " + err.message, true);
            hideLoader();
        })
        .getUpdateView();
}

function populateUpdateForm(data) {
    document.getElementById('update-to-id').value = data.TO_ID;
    document.getElementById('update-to-id-display').textContent = `Editing: ${data.TO_ID}`;
    
    document.getElementById('update-destination').value = data.Destination;
    document.getElementById('update-station').value = data.Station || '';
    document.getElementById('update-purpose').value = data.Purpose;
    
    const modeSelect = document.getElementById('update-modeOfTravel');
    const standardModes = ['GOVERNMENT VEHICLE', 'PRIVATE VEHICLE', 'PUBLIC TRANSPORT', 'AIR TRAVEL', 'SEA TRAVEL'];
    
    if (standardModes.includes(data.Mode_of_Travel)) {
        modeSelect.value = data.Mode_of_Travel;
    } else {
        modeSelect.value = 'OTHER';
        const otherContainer = document.getElementById('update-otherModeContainer');
        const otherInput = document.getElementById('update-otherMode');
        otherContainer.classList.remove('hidden');
        otherInput.value = data.Mode_of_Travel;
        otherInput.required = true;
    }
    
    // Pass the saved value to the dropdown function
    const requestingOfficerSelect = document.getElementById('update-requestingOfficer');
    populateProjectEngineerDropdown(requestingOfficerSelect, data.Requesting_Officer);
    requestingOfficerSelect.value = data.Requesting_Officer;

    const employeesContainer = document.getElementById('update-employees-container');
    employeesContainer.innerHTML = '';
    
    const employees = Array.isArray(data.Employees) ? data.Employees : [data.Employees || ''];
    employees.forEach((emp) => {
        // Pass the saved employee name to createEmployeeRow
        if(emp) {
            createEmployeeRow(employeesContainer, emp);
        }
    });
    
    // This will re-populate all dropdowns, but since createEmployeeRow
    // already set the value, it should be respected by updateAllEmployeeDropdowns
    updateAllEmployeeDropdowns('update-employees-container');

    const datePrepared = formatToYyyyMmDd(data.Date_Prepared);
    const inclusiveStart = formatToYyyyMmDd(data.Inclusive_Start);
    const inclusiveEnd = formatToYyyyMmDd(data.Inclusive_End);
    const dateSubmission = formatToYyyyMmDd(data.Date_Submission_Travel_Report);

    fpUpdateDatePrepared = flatpickr("#update-datePrepared", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        defaultDate: datePrepared,
        onChange: (selectedDates) => {
            if (selectedDates.length > 0) {
                const displayElem = document.getElementById('update-date-prepared-display');
                if (displayElem) {
                    displayElem.textContent = formatDateForDisplay(selectedDates[0].toISOString());
                }
                if (fpUpdateInclusive) fpUpdateInclusive.set('minDate', selectedDates[0]);
            }
        }
    });
    
    fpUpdateInclusive = flatpickr("#update-inclusiveDates", {
        mode: "range",
        dateFormat: "Y-m-d",
        minDate: datePrepared,
        defaultDate: [inclusiveStart, inclusiveEnd],
        onChange: (selectedDates) => {
            if (selectedDates.length === 2) {
                const startDate = selectedDates[0];
                const endDate = selectedDates[1];
                const formattedDisplay = formatInclusiveDates(startDate.toISOString(), endDate.toISOString());
                document.getElementById('update-inclusive-dates-display').textContent = formattedDisplay;
                if (fpUpdateSubmission) {
                    fpUpdateSubmission.set('minDate', endDate);
                }
            }
        }
    });

    fpUpdateSubmission = flatpickr("#update-dateSubmission", {
        dateFormat: "Y-m-d",
        minDate: inclusiveEnd,
        defaultDate: dateSubmission,
        onChange: (selectedDates) => {
            if (selectedDates.length > 0) {
                document.getElementById('update-submission-date-display').textContent = formatDateForDisplay(selectedDates[0].toISOString());
            }
        }
    });

    document.getElementById('update-inclusive-dates-display').textContent = formatInclusiveDates(data.Inclusive_Start, data.Inclusive_End);
    document.getElementById('update-submission-date-display').textContent = formatDateForDisplay(data.Date_Submission_Travel_Report);
    document.getElementById('update-date-prepared-display').textContent = formatDateForDisplay(data.Date_Prepared);
}

function setupUpdateFormListeners() {
    document.getElementById('update-to-form').addEventListener('submit', handleUpdateToSubmit);
    document.getElementById('cancel-update-to-btn').addEventListener('click', (e) => {
        e.preventDefault();
        // Go back to travel orders list
        loadTravelOrdersView();
    });
    
    const employeesContainer = document.getElementById('update-employees-container');
    document.getElementById('update-add-employee-btn').addEventListener('click', () => {
        createEmployeeRow(employeesContainer, null); // Pass null for new rows
    });
    
    setupModeOfTravelListener('update-modeOfTravel', 'update-otherModeContainer', 'update-otherMode');
    setupSuggestions('update-purpose', 'update-purpose-suggestions', RECENT_PURPOSES);
    setupSuggestions('update-station', 'update-station-suggestions', RECENT_STATIONS);
}

function validateUpdateToForm() {
    clearFormErrors('update-to-form');
    let isValid = true;
    
    const formData = {
        toId: document.getElementById('update-to-id').value,
        datePrepared: document.getElementById('update-datePrepared').value,
        inclusiveDates: document.getElementById('update-inclusiveDates').value,
        destination: document.getElementById('update-destination').value,
        station: document.getElementById('update-station').value,
        purpose: document.getElementById('update-purpose').value,
        modeOfTravel: document.getElementById('update-modeOfTravel').value,
        requestingOfficer: document.getElementById('update-requestingOfficer').value,
        dateSubmission: document.getElementById('update-dateSubmission').value,
    };
    
    if (formData.modeOfTravel === 'OTHER') {
        formData.modeOfTravel = document.getElementById('update-otherMode').value;
        if (!formData.modeOfTravel) {
            showFormError('update-otherMode', 'Please specify the mode of travel.');
            isValid = false;
        }
    }
    
    const employees = getSelectedEmployees('update-employees-container');
    
    if (employees.length === 0) {
        showToast("Please add at least one employee", true);
        isValid = false;
    }

    const requiredFields = [
        { id: 'update-datePrepared', name: 'Date Prepared', key: 'datePrepared' },
        { id: 'update-inclusiveDates', name: 'Inclusive Dates', key: 'inclusiveDates' },
        { id: 'update-destination', name: 'Destination', key: 'destination' },
        { id: 'update-station', name: 'Station', key: 'station' },
        { id: 'update-purpose', name: 'Purpose', key: 'purpose' },
        { id: 'update-modeOfTravel', name: 'Mode of Travel', key: 'modeOfTravel' },
        { id: 'update-requestingOfficer', name: 'Requesting Officer', key: 'requestingOfficer' },
        { id: 'update-dateSubmission', name: 'Submission Date', key: 'dateSubmission' }
    ];
    
    requiredFields.forEach(field => {
        if (!formData[field.key]) {
            showFormError(field.id, `${field.name} is required.`);
            isValid = false;
        }
    });

    if (!isValid) return null;

    const dp = new Date(formData.datePrepared + 'T00:00:00');
    const today = new Date(getTodayDate() + 'T00:00:00');
    
    if (dp > today) {
        showFormError('update-datePrepared', 'Date Prepared cannot be in the future.');
        isValid = false;
    }
    
    const [startStr, endStr] = formData.inclusiveDates.split(' to ');
    if (!startStr || !endStr) {
        showFormError('update-inclusiveDates', 'Please select a valid date range.');
        return null;
    }
    
    const start = new Date(startStr + 'T00:00:00');
    const end = new Date(endStr + 'T00:00:00');
    
    if (start < dp) {
        showFormError('update-inclusiveDates', 'Start Date cannot be before Date Prepared.');
        isValid = false;
    }
    
    const submission = new Date(formData.dateSubmission + 'T00:00:00');
    if (submission < end) {
        showFormError('update-dateSubmission', 'Submission Date cannot be before Inclusive End Date.');
        isValid = false;
    }

    if (!isValid) return null;

    return {
        datePrepared: dp.toISOString(),
        inclusiveStart: start.toISOString(),
        inclusiveEnd: end.toISOString(),
        dateSubmission: submission.toISOString(),
        employees: employees,
        destination: formData.destination,
        station: formData.station,
        purpose: formData.purpose,
        modeOfTravel: formData.modeOfTravel,
        requestingOfficer: formData.requestingOfficer,
    };
}

// MODIFICATION: handleUpdateToSubmit now calls update, then generates PDF
function handleUpdateToSubmit(e) {
    e.preventDefault();
    const formData = validateUpdateToForm();
    const toId = document.getElementById('update-to-id').value;
    
    if (formData) {
        showLoader("Updating Travel Order...");
        document.getElementById('update-to-btn').disabled = true;
        
        // Step 1: Call updateTravelOrder
        google.script.run
            .withSuccessHandler(result => onUpdateSuccess(result, toId)) // Pass toId
            .withFailureHandler(onUpdateFailure)
            .updateTravelOrder(formData, toId);
    }
}

// MODIFICATION: onUpdateSuccess now triggers the PDF generation
function onUpdateSuccess(result, toId) { // Receive toId
    if (result.success) {
        // Update global data (Step 1 successful)
        const index = ALL_TRAVEL_ORDERS.findIndex(to => to.TO_ID === result.updatedRecord.TO_ID);
        if (index !== -1) {
            ALL_TRAVEL_ORDERS[index] = result.updatedRecord;
        } else {
            ALL_TRAVEL_ORDERS.push(result.updatedRecord);
        }

        // Recalculate latest date prepared
        const newDatePrepared = new Date(result.updatedRecord.Date_Prepared);
        const latest = LATEST_DATE_PREPARED ? new Date(LATEST_DATE_PREPARED) : null;
        
        if (!latest || newDatePrepared > latest) {
            LATEST_DATE_PREPARED = newDatePrepared;
        } else if (latest && newDatePrepared.toISOString() === latest.toISOString()) {
            LATEST_DATE_PREPARED = ALL_TRAVEL_ORDERS.reduce((max, to) => {
                const d = new Date(to.Date_Prepared);
                return d > max ? d : max;
            }, new Date(0));
        }
        
        _successModalRedirect = 'travel_orders'; // Set redirect logic

        // Step 2: Now generate the PDF
        showLoader("Re-generating PDF...");
        google.script.run
            .withSuccessHandler(onPdfGenerateSuccess) // New handler for PDF
            .withFailureHandler(onUpdateFailure) // Can reuse update failure
            .generateAndLinkPdf(toId, null); // Call PDF generation

    } else {
        onUpdateFailure({ message: result.error });
    }
}

// MODIFICATION: New function to handle the success of PDF generation *after* update
function onPdfGenerateSuccess(pdfResult) {
    if (pdfResult.success) {
        // PDF generation is complete, now find the fully updated record
        // We need to refresh the local data
        const updatedRecord = ALL_TRAVEL_ORDERS.find(to => to.TO_ID === pdfResult.toId);
        if (updatedRecord) {
             updatedRecord.PDF_Link = pdfResult.pdfUrl;
             updatedRecord.Status = "Completed";
        }
        
        // Show success modal
        showSuccessModal(
            "Update Successful!",
            "Travel Order has been updated and PDF re-generated.",
            pdfResult.toId, // Use toId from pdfResult
            pdfResult.pdfUrl
        );
        
        // Re-enable button, hide loader
        const updateBtn = document.getElementById('update-to-btn');
        if (updateBtn) updateBtn.disabled = false;
        hideLoader();

    } else {
         onUpdateFailure({ message: pdfResult.error });
    }
}


function onUpdateFailure(error) {
    console.error("Update/PDF Error:", error);
    showToast("Update Failed: " + error.message, true);
    const updateBtn = document.getElementById('update-to-btn');
    if (updateBtn) updateBtn.disabled = false;
    hideLoader();
}

function resetNewToForm() {
    const form = document.getElementById('new-to-form');
    if (!form) return;

    form.reset(); // Resets basic inputs

    // Clear flatpickrs
    if (fpDatePrepared) fpDatePrepared.clear();
    if (fpInclusive) fpInclusive.clear();
    if (fpSubmission) fpSubmission.clear();

    // Clear display text
    document.getElementById('date-prepared-display').textContent = '';
    document.getElementById('inclusive-dates-display').textContent = '';
    document.getElementById('submission-date-display').textContent = '';

    // Disable dependent date pickers
    document.getElementById('inclusiveDates').disabled = true;
    document.getElementById('dateSubmission').disabled = true;

    // Reset employees
    const employeesContainer = document.getElementById('employees-container');
    employeesContainer.innerHTML = `
        <div class="employee-row flex gap-2">
            <select class="employee-select flex-1 input-field" required>
                <option value="">Select Employee</option>
            </select>
            <button type="button" class="remove-employee-btn hidden bg-red-50 text-red-600 px-4 rounded-lg hover:bg-red-100 transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        </div>
    `;
    populateEmployeeDropdown(employeesContainer.querySelector('.employee-select'));
    updateEmployeeRemoveButtons(employeesContainer);

    // Reset 'Other' mode of travel
    document.getElementById('otherModeContainer').classList.add('hidden');
    document.getElementById('otherMode').required = false;

    // Clear suggestion dropdowns if they exist
    const purposeSuggestions = document.getElementById('purpose-suggestions');
    if (purposeSuggestions) purposeSuggestions.classList.add('hidden');
    const stationSuggestions = document.getElementById('station-suggestions');
    if (stationSuggestions) stationSuggestions.classList.add('hidden');
    
    // Clear errors
    clearFormErrors('new-to-form');
}
</script>
