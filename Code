// ==================== CONFIGURATION ====================
const DATABASE_SHEET_ID = "1TlcVa6NAX-2o4qGzfb1jsw3tD-R8L8K5jucwLcD_mGA";
const PDF_TEMPLATE_DOC_ID = "1NXH4c9kAf7L2ILw0egJZaETEeiah5fvH61JRpuxEW0o"; // Not used anymore
const TARGET_PDF_FOLDER_ID = "1PmESdk0hdF0H38eTOOJ-uOlhAOMz6-by";

const DB_SHEET_NAME = "Travel Orders";
const TO_FORM_SHEET_NAME = "TO FORM";
const PROJECT_ENGINEER_MASTER_SHEET = "Project Engineer Master";
const EMPLOYEES_MASTER_SHEET = "Employees Master";
const APPROVERS_MASTER_SHEET = "Approvers Master";
const PW_SHEET_NAME = "PW";
const TO_ID_PREFIX = "RO2.2";
const TO_ID_CONNECTOR = "-JO";

const HEADERS = [
  "TO_ID", "Date_Prepared", "Inclusive_Start", "Inclusive_End", "Employees", "Destination", 
  "KM_Radius", "Station", "Purpose", "Mode_of_Travel", "Requesting_Officer", "Date_Submission_Travel_Report", 
  "Status", "PDF_Link", "Created_By", "Created_Date", "Last_Modified_By", "Last_Modified_Date"
];
const DATE_COLUMNS = [2, 3, 4, 12, 16, 18];

// ==================== MENU ====================
function onOpen(e) {
  SpreadsheetApp.getUi()
    .createMenu('Travel Order System')
    .addItem('Open System', 'showWebApp')
    .addToUi();
}

function setupSheetHeaders() {
  const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
  if (sheet.getRange("A1").getValue() === "") {
    sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]).setFontWeight("bold");
    sheet.setFrozenRows(1);
    Logger.log("Headers written to " + DB_SHEET_NAME);
  } else {
    Logger.log("Headers already exist.");
  }
}

function showWebApp() {
  const html = HtmlService.createTemplateFromFile('main')
    .evaluate()
    .setTitle('Travel Order Management System')
    .setWidth(1400)
    .setHeight(900);
  SpreadsheetApp.getUi().showModalDialog(html, 'Travel Order Management System');
}

function doGet(e) {
  return HtmlService.createTemplateFromFile('main')
    .evaluate()
    .setTitle('Travel Order Management System')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

function checkAdminPassword(password) {
  const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(PW_SHEET_NAME);
  if (sheet) {
    const correctPassword = sheet.getRange("A1").getValue();
    return password === correctPassword;
  }
  return false;
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// ==================== UI FUNCTIONS ====================
function getDashboardView() {
  return HtmlService.createHtmlOutputFromFile('dashboard').getContent();
}

function getNewToView() {
  return HtmlService.createHtmlOutputFromFile('newTo').getContent();
}

function getUpdateView() {
  return HtmlService.createHtmlOutputFromFile('update').getContent();
}

function getTravelOrdersView() {
  return HtmlService.createHtmlOutputFromFile('travelOrders').getContent();
}

function getMasterDataView() {
  return HtmlService.createHtmlOutputFromFile('masterData').getContent();
}

// ==================== DATA RETRIEVAL ====================
function getInitialData() {
  try {
    const data = getAllTravelOrders();
    const projectEngineers = getProjectEngineers();
    const employees = getEmployees();
    const approvers = getApprovers();
    
    const recentPurposes = [...new Set(data.map(to => to.Purpose).filter(Boolean))].slice(0, 10);
    const recentStations = [...new Set(data.map(to => to.Station).filter(Boolean))].slice(0, 10);
    
    const employeePositions = [...new Set(employees.map(e => e.position).filter(Boolean))];
    const engineerPositions = [...new Set(projectEngineers.map(e => e.position).filter(Boolean))];
    
    const latestDate = getLatestDatePrepared();
    
    const result = {
      travelOrders: data,
      latestDate: latestDate ? latestDate.toISOString() : null,
      projectEngineers: projectEngineers,
      employees: employees,
      approvers: approvers,
      recentPurposes: recentPurposes,
      recentStations: recentStations,
      employeePositions: employeePositions, 
      engineerPositions: engineerPositions 
    };
    
    Logger.log("getInitialData returning " + data.length + " travel orders");
    return result;
  } catch (e) {
    Logger.log("ERROR in getInitialData: " + e.message);
    Logger.log(e.stack);
    return { error: e.message };
  }
}

function getAllTravelOrders() {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
    const range = sheet.getDataRange();
    const values = range.getValues();
    
    if (values.length <= 1) {
      Logger.log("No travel orders found - only headers present");
      return [];
    }
    
    const headers = values.shift();
    Logger.log("Headers: " + headers.join(", "));

    const data = values.map((row) => {
      let obj = {};
      headers.forEach((header, i) => {
        if (DATE_COLUMNS.includes(i + 1) && row[i]) {
          obj[header] = new Date(row[i]).toISOString();
        } else if (header === "Employees" && row[i]) {
          try {
            obj[header] = JSON.parse(row[i]);
          } catch (e) {
            obj[header] = [row[i]];
          }
        } else {
          obj[header] = row[i];
        }
      });
      return obj;
    });
    
    Logger.log("getAllTravelOrders returning " + data.length + " records");
    return data;
  } catch (e) {
    Logger.log("ERROR in getAllTravelOrders: " + e.message);
    return [];
  }
}

function getTravelOrderById(toId) {
  const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const idColIndex = headers.indexOf("TO_ID");

  if (idColIndex === -1) {
    throw new Error("TO_ID column not found.");
  }

  const row = data.find(r => r[idColIndex] === toId);
  if (!row) return null;

  let obj = {};
  headers.forEach((header, i) => {
    if (DATE_COLUMNS.includes(i + 1) && row[i]) {
      obj[header] = new Date(row[i]).toISOString();
    } else if (header === "Employees" && row[i]) {
      try {
        obj[header] = JSON.parse(row[i]);
      } catch (e) {
        obj[header] = [row[i]];
      }
    } else {
      obj[header] = row[i];
    }
  });
  return obj;
}

// ==================== CREATE TRAVEL ORDER ====================
function saveTravelOrder(form) {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
    const userEmail = Session.getActiveUser().getEmail();
    const now = new Date();

    const datePrepared = new Date(form.datePrepared);
    const start = new Date(form.inclusiveStart);
    const end = new Date(form.inclusiveEnd);
    const submission = new Date(form.dateSubmission);

    if (datePrepared > new Date()) throw new Error("Date Prepared cannot be in the future.");
    if (start < datePrepared) throw new Error("Start Date cannot be before Date Prepared.");
    if (end < start) throw new Error("End Date cannot be before Start Date.");
    if (submission < end) throw new Error("Submission date cannot be before End Date.");

    const toId = generateToId(datePrepared);
    
    const employeesJson = JSON.stringify(form.employees.map(e => e.toUpperCase()));

    // MODIFICATION: Use form.kmRadius instead of hardcoded default
    const newRow = [
      toId,
      Utilities.formatDate(datePrepared, "Asia/Manila", "yyyy-MM-dd"),
      Utilities.formatDate(start, "Asia/Manila", "yyyy-MM-dd"),
      Utilities.formatDate(end, "Asia/Manila", "yyyy-MM-dd"),
      employeesJson,
      form.destination.toUpperCase(),
      form.kmRadius || "WITHIN 50 KM RADIUS", // Use form value, with fallback
      form.station.toUpperCase(),
      form.purpose.toUpperCase(),
      form.modeOfTravel.toUpperCase(),
      form.requestingOfficer.toUpperCase(),
      Utilities.formatDate(submission, "Asia/Manila", "yyyy-MM-dd"),
      "Pending PDF",
      "",
      userEmail,
      now,
      userEmail,
      now
    ];
    // END MODIFICATION

    sheet.appendRow(newRow);
    
    const newRowNumber = sheet.getLastRow();
    const pdfResult = generateAndLinkPdf(toId, newRowNumber);
    const newRecord = getTravelOrderById(toId);
    
    return { success: true, newRecord: newRecord, pdfUrl: pdfResult.pdfUrl };

  } catch (e) {
    Logger.log(e);
    return { success: false, error: e.message };
  }
}

// ==================== UPDATE TRAVEL ORDER ====================
function updateTravelOrder(form, toId) {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    const headers = data.shift();
    const idColIndex = headers.indexOf("TO_ID");

    const rowIndex = data.findIndex(r => r[idColIndex] === toId);
    if (rowIndex === -1) {
      throw new Error("Travel Order not found for update.");
    }
    
    const rowNumber = rowIndex + 2;

    const datePrepared = new Date(form.datePrepared);
    const start = new Date(form.inclusiveStart);
    const end = new Date(form.inclusiveEnd);
    const submission = new Date(form.dateSubmission);
    
    if (datePrepared > new Date()) throw new Error("Date Prepared cannot be in the future.");
    if (start < datePrepared) throw new Error("Start Date cannot be before Date Prepared.");
    if (end < start) throw new Error("End Date cannot be before Start Date.");
    if (submission < end) throw new Error("Submission date cannot be before End Date.");

    const employeesJson = JSON.stringify(form.employees.map(e => e.toUpperCase()));

    // MODIFICATION: Use form.kmRadius instead of hardcoded default
    const updateData = {
      "Date_Prepared": Utilities.formatDate(datePrepared, "Asia/Manila", "yyyy-MM-dd"),
      "Inclusive_Start": Utilities.formatDate(start, "Asia/Manila", "yyyy-MM-dd"),
      "Inclusive_End": Utilities.formatDate(end, "Asia/Manila", "yyyy-MM-dd"),
      "Employees": employeesJson,
      "Destination": form.destination.toUpperCase(),
      "KM_Radius": form.kmRadius || "WITHIN 50 KM RADIUS", // Use form value, with fallback
      "Station": form.station.toUpperCase(),
      "Purpose": form.purpose.toUpperCase(),
      "Mode_of_Travel": form.modeOfTravel.toUpperCase(),
      "Requesting_Officer": form.requestingOfficer.toUpperCase(),
      "Date_Submission_Travel_Report": Utilities.formatDate(submission, "Asia/Manila", "yyyy-MM-dd"),
      "Last_Modified_By": Session.getActiveUser().getEmail(),
      "Last_Modified_Date": new Date(),
      "Status": "Pending PDF",
      "PDF_Link": ""
    };
    // END MODIFICATION

    headers.forEach((header, index) => {
      if (updateData[header] !== undefined) {
        sheet.getRange(rowNumber, index + 1).setValue(updateData[header]);
      }
    });

    const updatedRecord = getTravelOrderById(toId);
    
    return { success: true, updatedRecord: updatedRecord, pdfUrl: null };

  } catch (e) {
    Logger.log(e);
    return { success: false, error: e.message };
  }
}

// ==================== PDF GENERATION ====================
function generateAndLinkPdf(toId, rowNumber) {
  try {
    const ss = SpreadsheetApp.openById(DATABASE_SHEET_ID);
    const dataSheet = ss.getSheetByName(DB_SHEET_NAME);
    const toFormSheet = ss.getSheetByName(TO_FORM_SHEET_NAME);
    
    if (!toFormSheet) {
      throw new Error("TO FORM sheet not found in database spreadsheet.");
    }
    
    const dataRange = dataSheet.getDataRange();
    const allData = dataRange.getValues();
    const headers = allData.shift();
    
    if (!rowNumber) {
      const idColIndex = headers.indexOf("TO_ID");
      if (idColIndex === -1) {
        throw new Error("TO_ID column not found in sheet.");
      }
      
      const rowIndex = allData.findIndex(r => r[idColIndex] === toId);
      if (rowIndex === -1) {
        throw new Error(`TO_ID '${toId}' not found in sheet.`);
      }
      rowNumber = rowIndex + 2;
    }

    const rowData = dataSheet.getRange(rowNumber, 1, 1, headers.length).getValues()[0];
    
    const data = {};
    headers.forEach((header, i) => {
      data[header] = rowData[i];
    });

    const datePrepared = new Date(data.Date_Prepared);
    const startDate = new Date(data.Inclusive_Start);
    const endDate = new Date(data.Inclusive_End);
    const submissionDate = new Date(data.Date_Submission_Travel_Report);
    
    let employeesArray = [];
    try {
      employeesArray = JSON.parse(data.Employees);
    } catch (e) {
      employeesArray = [data.Employees];
    }
    
    toFormSheet.getRange('B13:B30').clearContent();
    toFormSheet.getRange('F13:F30').clearContent();
    
    toFormSheet.getRange('C7').setValue(toId);
    toFormSheet.getRange('G7').setValue(Utilities.formatDate(datePrepared, "Asia/Manila", "MMMM dd, yyyy"));
    
    // This logic already correctly uses the KM_Radius field
    const destinationWithRadius = `${data.Destination} (${data.KM_Radius})`;
    toFormSheet.getRange('C24').setValue(destinationWithRadius);
    
    toFormSheet.getRange('C26').setValue(data.Station);
    toFormSheet.getRange('C28').setValue(data.Purpose);
    toFormSheet.getRange('F32').setValue(data.Requesting_Officer);
    toFormSheet.getRange('F33').setValue("N/A");
    toFormSheet.getRange('F35').setValue(formatInclusiveDates(startDate, endDate));
    toFormSheet.getRange('F37').setValue(data.Mode_of_Travel);
    toFormSheet.getRange('D38').setValue(Utilities.formatDate(submissionDate, "Asia/Manila", "MMMM dd, yyyy"));
    
    const approver = getActiveApprover();
    toFormSheet.getRange('B47').setValue(approver.name);
    toFormSheet.getRange('B48').setValue(approver.position);
    
    employeesArray.forEach((empName, index) => {
      const row = 13 + index;
      toFormSheet.getRange(`B${row}`).setValue(empName);
      
      const empData = getEmployeeByName(empName);
      if (empData) {
        toFormSheet.getRange(`F${row}`).setValue(empData.position);
      }
    });
    
    // This logic already correctly uses the KM_Radius field
    const row41Range = toFormSheet.getRange('A41:Z41');
    if (data.KM_Radius === 'BEYOND 50 KM RADIUS') {
      row41Range.setFontColor('#000000');
    } else {
      row41Range.setFontColor('#FFFFFF');
    }
    
    SpreadsheetApp.flush();
    
    const pdfBlob = toFormSheet.getAs('application/pdf');
    const pdfName = `TO - ${toId} - ${employeesArray[0] || 'Unknown'}.pdf`;
    pdfBlob.setName(pdfName);
    
    const targetFolder = DriveApp.getFolderById(TARGET_PDF_FOLDER_ID);
    const pdfFile = targetFolder.createFile(pdfBlob);
    const pdfUrl = pdfFile.getUrl();
    
    const pdfLinkCol = headers.indexOf("PDF_Link") + 1;
    const statusCol = headers.indexOf("Status") + 1;
    
    dataSheet.getRange(rowNumber, pdfLinkCol).setValue(pdfUrl);
    dataSheet.getRange(rowNumber, statusCol).setValue("Completed");
    
    return { success: true, pdfUrl: pdfUrl };

  } catch (e) {
    Logger.log(e);
    try {
      if (rowNumber) {
        const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
        const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
        const statusCol = headers.indexOf("Status") + 1;
        sheet.getRange(rowNumber, statusCol).setValue("PDF Error");
      }
    } catch (err) {}

    return { success: false, error: e.message };
  }
}

// ==================== HELPER FUNCTIONS ====================
function getLatestDatePrepared() {
  const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
  const range = sheet.getRange("B2:B");
  const values = range.getValues();
  
  let latestDate = null;
  for (let i = 0; i < values.length; i++) {
    if (values[i][0]) {
      let d = new Date(values[i][0]);
      if (latestDate === null || d > latestDate) {
        latestDate = d;
      }
    }
  }
  return latestDate;
}

function generateToId(datePrepared) {
  const year = datePrepared.getFullYear();
  const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
  const idColumn = sheet.getRange("A2:A").getValues();
  
  let maxSerial = 0;
  const regex = new RegExp(`${TO_ID_PREFIX}-(\\d{4})${TO_ID_CONNECTOR}(\\d{5})`);

  for (let i = 0; i < idColumn.length; i++) {
    if (idColumn[i][0]) {
      const match = idColumn[i][0].match(regex);
      if (match) {
        const idYear = parseInt(match[1], 10);
        const idSerial = parseInt(match[2], 10);
        if (idYear === year && idSerial > maxSerial) {
          maxSerial = idSerial;
        }
      }
    }
  }

  const newSerial = maxSerial + 1;
  const paddedSerial = String(newSerial).padStart(5, '0');
  
  return `${TO_ID_PREFIX}-${year}${TO_ID_CONNECTOR}${paddedSerial}`;
}

function formatInclusiveDates(startDate, endDate) {
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  const startStr = startDate.toLocaleDateString('en-US', options);
  const endStr = endDate.toLocaleDateString('en-US', options);

  if (startStr === endStr) {
    return startStr;
  }

  const startMonth = startDate.getMonth();
  const startYear = startDate.getFullYear();
  const endMonth = endDate.getMonth();
  const endYear = endDate.getFullYear();

  if (startYear !== endYear) {
    return `${startStr} – ${endStr}`;
  }
  
  if (startMonth !== endMonth) {
    return `${startDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}, ${startYear} – ${endStr}`;
  }
  
  const startDay = startDate.getDate();
  const endDay = endDate.getDate();
  return `${startDate.toLocaleDateString('en-US', { month: 'long' })} ${startDay}–${endDay}, ${startYear}`;
}

// ==================== MASTER DATA FUNCTIONS ====================
function getProjectEngineers() {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(PROJECT_ENGINEER_MASTER_SHEET);
    if (!sheet) {
      Logger.log("Project Engineer Master sheet not found");
      return [];
    }
    const data = sheet.getDataRange().getValues();
    if (data.length < 2) {
      Logger.log("No data in Project Engineer Master sheet");
      return [];
    }
    const headers = data[0];
    const nameIdx = headers.indexOf("Name");
    const positionIdx = headers.indexOf("Position");
    const statusIdx = headers.indexOf("Status");
    if (nameIdx === -1) {
      Logger.log("Name column not found in Project Engineer Master");
      return [];
    }
    const result = data.slice(1)
      .filter(row => row[nameIdx] && row[nameIdx].toString().trim() !== "")
      .map(row => ({
        name: row[nameIdx].toString().trim().toUpperCase(),
        position: positionIdx !== -1 && row[positionIdx] ? row[positionIdx].toString().trim().toUpperCase() : "",
        status: statusIdx !== -1 && row[statusIdx] ? row[statusIdx].toString().trim().toUpperCase() : "ACTIVE"
      }))
      .filter(item => item.status === "ACTIVE");
    
    Logger.log("getProjectEngineers returning " + result.length + " engineers");
    return result;
  } catch (e) {
    Logger.log("ERROR in getProjectEngineers: " + e.message);
    return [];
  }
}

function getEmployees() {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(EMPLOYEES_MASTER_SHEET);
    if (!sheet) {
      Logger.log("Employees Master sheet not found");
      return [];
    }
    const data = sheet.getDataRange().getValues();
    if (data.length < 2) {
      Logger.log("No data in Employees Master sheet");
      return [];
    }
    const headers = data[0];
    const empIdIdx = headers.indexOf("Employee_ID");
    const nameIdx = headers.indexOf("Name");
    const positionIdx = headers.indexOf("Position");
    const statusIdx = headers.indexOf("Status");
    
    if (nameIdx === -1) {
      Logger.log("Name column not found in Employees Master");
      return [];
    }
    
    const result = data.slice(1)
      .filter(row => row[nameIdx] && row[nameIdx].toString().trim() !== "")
      .map(row => ({
        employeeId: empIdIdx !== -1 ? row[empIdIdx].toString().trim() : "",
        name: row[nameIdx].toString().trim().toUpperCase(),
        position: positionIdx !== -1 && row[positionIdx] ? row[positionIdx].toString().trim().toUpperCase() : "",
        status: statusIdx !== -1 && row[statusIdx] ? row[statusIdx].toString().trim().toUpperCase() : "ACTIVE"
      }))
      .filter(item => item.status === "ACTIVE");
    
    Logger.log("getEmployees returning " + result.length + " employees");
    return result;
  } catch (e) {
    Logger.log("ERROR in getEmployees: " + e.message);
    return [];
  }
}

function getEmployeeByName(name) {
  const employees = getEmployees();
  return employees.find(emp => emp.name.toUpperCase() === name.toUpperCase());
}

function getApprovers() {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(APPROVERS_MASTER_SHEET);
    if (!sheet) {
      Logger.log("Approvers Master sheet not found");
      return [];
    }
    const data = sheet.getDataRange().getValues();
    if (data.length < 2) {
      Logger.log("No data in Approvers Master sheet");
      return [];
    }
    const headers = data[0];
    const nameIdx = headers.indexOf("Name");
    const positionIdx = headers.indexOf("Position");
    const statusIdx = headers.indexOf("Status");
    
    if (nameIdx === -1) {
      Logger.log("Name column not found in Approvers Master");
      return [];
    }
    
    const result = data.slice(1)
      .filter(row => row[nameIdx] && row[nameIdx].toString().trim() !== "")
      .map(row => ({
        name: row[nameIdx].toString().trim().toUpperCase(),
        position: positionIdx !== -1 && row[positionIdx] ? row[positionIdx].toString().trim().toUpperCase() : "",
        status: statusIdx !== -1 && row[statusIdx] ? row[statusIdx].toString().trim().toUpperCase() : "INACTIVE"
      }));
    
    Logger.log("getApprovers returning " + result.length + " approvers");
    return result;
  } catch (e) {
    Logger.log("ERROR in getApprovers: " + e.message);
    return [];
  }
}

function getActiveApprover() {
  const approvers = getApprovers();
  const active = approvers.find(a => a.status === "ACTIVE");
  return active || { name: "N/A", position: "N/A" };
}

function setActiveApprover(name, position) {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(APPROVERS_MASTER_SHEET);
    if (!sheet) {
      throw new Error("Approvers Master sheet not found");
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    const nameIdx = headers.indexOf("Name");
    const statusIdx = headers.indexOf("Status");
    const positionIdx = headers.indexOf("Position");
    
    if (nameIdx === -1 || statusIdx === -1 || positionIdx === -1) {
      throw new Error("Required columns (Name, Status, Position) not found in Approvers sheet");
    }

    let newActiveRow = -1;

    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowName = row[nameIdx];
      const rowStatus = row[statusIdx];
      
      if (rowName === name) {
        newActiveRow = i + 1;
        sheet.getRange(newActiveRow, statusIdx + 1).setValue("ACTIVE");
        sheet.getRange(newActiveRow, positionIdx + 1).setValue(position.toUpperCase());
      } else if (rowStatus === "ACTIVE") {
        sheet.getRange(i + 1, statusIdx + 1).setValue("INACTIVE");
      }
    }

    if (newActiveRow === -1) {
      throw new Error(`Approver with name '${name}' not found to set as active.`);
    }

    return { success: true };
  } catch (e) {
    Logger.log(e);
    return { success: false, error: e.message };
  }
}

function saveMasterData(type, data) {
  try {
    let sheetName;
    let newRow;
    let headers;

    if (type === 'employee') {
      sheetName = EMPLOYEES_MASTER_SHEET;
      headers = ["Employee_ID", "Name", "Position", "Status"];
      newRow = [data.employeeId, data.name.toUpperCase(), data.position.toUpperCase(), data.status || "ACTIVE"];
    } else if (type === 'engineer') {
      sheetName = PROJECT_ENGINEER_MASTER_SHEET;
      headers = ["Name", "Position", "Status"];
      newRow = [data.name.toUpperCase(), data.position.toUpperCase(), data.status || "ACTIVE"];
    } else if (type === 'approver') {
      sheetName = APPROVERS_MASTER_SHEET;
      headers = ["Name", "Position", "Status"];
      newRow = [data.name.toUpperCase(), data.position.toUpperCase(), data.status || "INACTIVE"];
    } else {
      throw new Error("Invalid master data type");
    }

    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(sheetName);
    if (!sheet) {
      throw new Error(`${sheetName} sheet not found`);
    }

    if (sheet.getRange("A1").getValue() === "") {
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight("bold");
      sheet.setFrozenRows(1);
    }

    sheet.appendRow(newRow);

    return { success: true };
  } catch (e) {
    Logger.log(e);
    return { success: false, error: e.message };
  }
}

function updateMasterData(type, rowNum, data) {
  try {
    let sheetName;
    if (type === 'employee') sheetName = EMPLOYEES_MASTER_SHEET;
    else if (type === 'engineer') sheetName = PROJECT_ENGINEER_MASTER_SHEET;
    else if (type === 'approver') sheetName = APPROVERS_MASTER_SHEET;
    else throw new Error("Invalid master data type");

    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(sheetName);
    if (!sheet) throw new Error(`${sheetName} sheet not found`);

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const nameIdx = headers.indexOf("Name");
    const positionIdx = headers.indexOf("Position");
    const statusIdx = headers.indexOf("Status");

    if (nameIdx !== -1 && data.name) {
      sheet.getRange(rowNum, nameIdx + 1).setValue(data.name.toUpperCase());
    }
    if (positionIdx !== -1 && data.position) {
      sheet.getRange(rowNum, positionIdx + 1).setValue(data.position.toUpperCase());
    }
    if (statusIdx !== -1 && data.status) {
      sheet.getRange(rowNum, statusIdx + 1).setValue(data.status.toUpperCase());
    }

    if (type === 'employee') {
      const empIdIdx = headers.indexOf("Employee_ID");
      if (empIdIdx !== -1 && data.employeeId) {
        sheet.getRange(rowNum, empIdIdx + 1).setValue(data.employeeId);
      }
    }

    return { success: true };
  } catch (e) {
    Logger.log(e);
    return { success: false, error: e.message };
  }
}

// ==================== DASHBOARD ANALYTICS ====================
function getDashboardAnalytics() {
  try {
    const allOrders = getAllTravelOrders();
    
    Logger.log("getDashboardAnalytics - Total orders: " + allOrders.length);

    const totalOrders = allOrders.length;
    const completedOrders = allOrders.filter(o => o.Status === "Completed").length;
    const pendingOrders = allOrders.filter(o => o.Status === "Pending PDF").length;
    const errorOrders = allOrders.filter(o => o.Status === "PDF Error").length;

    const employeeStats = {};
    allOrders.forEach(order => {
      const employees = Array.isArray(order.Employees) ? order.Employees : [order.Employees];
      employees.forEach(emp => {
        if (emp) {
          employeeStats[emp] = (employeeStats[emp] || 0) + 1;
        }
      });
    });

    const topEmployees = Object.entries(employeeStats)
      .map(([name, count]) => ({ name, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 10);

    const monthlyStats = {};
    const now = new Date();
    for (let i = 11; i >= 0; i--) {
      const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
      const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      monthlyStats[key] = 0;
    }

    allOrders.forEach(order => {
      if (order.Date_Prepared) {
        const date = new Date(order.Date_Prepared);
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (monthlyStats.hasOwnProperty(key)) {
          monthlyStats[key]++;
        }
      }
    });

    const monthlyData = Object.entries(monthlyStats).map(([month, count]) => ({
      month,
      count
    }));

    const modeStats = {};
    allOrders.forEach(order => {
      if (order.Mode_of_Travel) {
        modeStats[order.Mode_of_Travel] = (modeStats[order.Mode_of_Travel] || 0) + 1;
      }
    });

    const travelModes = Object.entries(modeStats)
      .map(([mode, count]) => ({ mode, count }))
      .sort((a, b) => b.count - a.count);

    const purposeStats = {};
    allOrders.forEach(order => {
      if (order.Purpose) {
        purposeStats[order.Purpose] = (purposeStats[order.Purpose] || 0) + 1;
      }
    });

    const topPurposes = Object.entries(purposeStats)
      .map(([purpose, count]) => ({ purpose, count }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 5);

    const recentOrders = allOrders
      .sort((a, b) => {
        const dateA = a.Created_Date ? new Date(a.Created_Date) : new Date(0);
        const dateB = b.Created_Date ? new Date(b.Created_Date) : new Date(0);
        return dateB - dateA;
      })
      .slice(0, 5);

    return {
      totalOrders,
      completedOrders,
      pendingOrders,
      errorOrders,
      topEmployees,
      monthlyData,
      travelModes,
      topPurposes,
      recentOrders
    };
  } catch (e) {
    Logger.log("ERROR in getDashboardAnalytics: " + e.message);
    Logger.log("Stack trace: " + e.stack);
    
    return {
      totalOrders: 0,
      completedOrders: 0,
      pendingOrders: 0,
      errorOrders: 0,
      topEmployees: [],
      monthlyData: [],
      travelModes: [],
      topPurposes: [],
      recentOrders: []
    };
  }
}

// ==================== DEBUG ANALYTICS FUNCTION ====================
// Add this to your Code.gs to debug the issue

function testGetAllTravelOrders() {
  try {
    const sheet = SpreadsheetApp.openById(DATABASE_SHEET_ID).getSheetByName(DB_SHEET_NAME);
    Logger.log("Sheet found: " + (sheet ? "YES" : "NO"));
    
    if (!sheet) {
      Logger.log("ERROR: Sheet '" + DB_SHEET_NAME + "' not found!");
      return;
    }
    
    const range = sheet.getDataRange();
    const values = range.getValues();
    Logger.log("Total rows in sheet: " + values.length);
    
    if (values.length > 0) {
      Logger.log("First row (headers): " + values[0].join(", "));
    }
    
    if (values.length > 1) {
      Logger.log("Second row (first data): " + values[1].join(", "));
    }
    
    const data = getAllTravelOrders();
    Logger.log("getAllTravelOrders returned " + data.length + " records");
    
    if (data.length > 0) {
      Logger.log("First record: " + JSON.stringify(data[0]));
    }
    
  } catch (e) {
    Logger.log("ERROR: " + e.message);
    Logger.log("Stack: " + e.stack);
  }
}

function testDashboardAnalytics() {
  try {
    Logger.log("=== TESTING DASHBOARD ANALYTICS ===");
    
    const result = getDashboardAnalytics();
    
    Logger.log("Result type: " + typeof result);
    Logger.log("Result: " + JSON.stringify(result));
    
    if (result) {
      Logger.log("Total Orders: " + result.totalOrders);
      Logger.log("Top Employees count: " + (result.topEmployees ? result.topEmployees.length : 0));
      Logger.log("Monthly Data count: " + (result.monthlyData ? result.monthlyData.length : 0));
    }
    
  } catch (e) {
    Logger.log("ERROR in testDashboardAnalytics: " + e.message);
    Logger.log("Stack: " + e.stack);
  }
}

// Run this to check your sheet configuration
function checkConfiguration() {
  Logger.log("=== CHECKING CONFIGURATION ===");
  Logger.log("DATABASE_SHEET_ID: " + DATABASE_SHEET_ID);
  Logger.log("DB_SHEET_NAME: " + DB_SHEET_NAME);
  
  try {
    const ss = SpreadsheetApp.openById(DATABASE_SHEET_ID);
    Logger.log("Spreadsheet found: YES");
    Logger.log("Spreadsheet name: " + ss.getName());
    
    const sheets = ss.getSheets();
    Logger.log("Available sheets:");
    sheets.forEach(sheet => {
      Logger.log("  - " + sheet.getName());
    });
    
    const targetSheet = ss.getSheetByName(DB_SHEET_NAME);
    if (targetSheet) {
      Logger.log("Target sheet '" + DB_SHEET_NAME + "' found: YES");
      Logger.log("Rows in target sheet: " + targetSheet.getLastRow());
      Logger.log("Columns in target sheet: " + targetSheet.getLastColumn());
    } else {
      Logger.log("Target sheet '" + DB_SHEET_NAME + "' found: NO");
    }
    
  } catch (e) {
    Logger.log("ERROR: " + e.message);
  }
}
